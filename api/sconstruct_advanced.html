<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>xpcc: 3.3 SConstruct files: Advanced topics</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">xpcc
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('sconstruct_advanced.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">3.3 SConstruct files: Advanced topics </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>One important thing to remember about SConstruct files is that they are declarative, rather than strictly imperative.</p>
<p>This means that the order in which the SCons functions are called in the SConstruct file does not affect the order in which SCons actually builds the programs and object files you want it to build.</p>
<p>With the SConstruct file you tell SCons what you want done and let SCons figure out the order in which to do it.</p>
<h2><a class="anchor" id="example"></a>
Example</h2>
<p>Let's start with a complex example for a SConstruct file used to build a project for an AVR:</p>
<p>First the 'project.cfg' configuration file: </p>
<div class="fragment"><pre class="fragment">[general]
name = example

[build]
architecture = avr
device = atmega644
clock = 14745600

[avrdude]
port = usb
programmer = avrispmkII

[fusebits]
<span class="preprocessor"># ext. crystal oscillator, jtag disabled, brown-out level at 4.3V</span>
<span class="preprocessor"></span>lfuse = 0xef
hfuse = 0xd9
efuse = 0xfc

[defines]
mcp2515_clock = 16000000
</pre></div><p>(For a detailed explanation about the synatx of the configuration file see the associated section: <a class="el" href="configuration_files.html">Configuration files</a>)</p>
<p>Together with this SConstruct file:</p>
<div class="fragment"><pre class="fragment">
env = Environment(tools = ['xpcc'], toolpath = ['../scons'])

files = env.FindFiles(path = '.')

program = env.Program(target = env['XPCC_CONFIG']['general']['name'], source = files.sources)

env.XpccLibrary()

env.Defines()

env.Alias('size', env.Size(program))
env.Alias('symbols', env.Symbols(program))

hexfile = env.Hex(program)
env.Alias('program', env.Avrdude(hexfile))

env.Alias('build', [hexfile, env.Listing(program)])
env.Alias('fuse', env.AvrdudeFuses())
env.Alias('all', ['build', 'size'])

env.Default('all')
</pre></div><h2><a class="anchor" id="description"></a>
Detailed description</h2>
<p>Let's get through this step by step:</p>
<div class="fragment"><pre class="fragment">
env = Environment(tools = ['xpcc'], toolpath = ['../../xpcc/scons'])
</pre></div><p>Create an environment and load the <a class="el" href="scons_tools.html">xpcc tool</a>. This checks the configuration file and finds the <em>build</em> section with an <em>architecture</em> entry. Form the value (here <em>'atmega'</em>) it determines that we want to compile code for and AVR and loads the complete AVR toolchain among the XPCC specific tools.</p>
<p>Therefore things like <em>Hex</em> or <em>Avrdude</em> are available. This might not be true if we specifiy another architecture.</p>
<p>Read more about this on the page about our <a class="el" href="scons_tools.html">SCons tools</a>.</p>
<div class="fragment"><pre class="fragment">
files = env.FindFiles(path = '.')
</pre></div><p>See <a class="el" href="tool_configfile.html#tool_configfile_find">FindFiles()</a>.</p>
<div class="fragment"><pre class="fragment">
program = env.Program(target = env['XPCC_CONFIG']['general']['name'], source = files.sources)
</pre></div><p>Create our program from all source files found in the project folder and the subfolders.</p>
<p>The name of the executable is determined here by the value in of the <em>name</em> entry in the section <em>general</em> of our configuration file. For this example it is <b>example</b>. Therefore the resulting file will be called <code>example.elf</code>. Elf is the standard file-ending for AVR executeables and is added automatically by SCons. If the program would be a Windows executable the name would be <code>example.exe</code>.</p>
<p>You can see another important feature of the <a class="el" href="scons_tools.html">xpcc tool</a> here: Everything from the configuration file is accessible throu the Python dict in <em>env</em>['XPCC_CONFIG']. For example <code>print env['XPCC_CONFIG']['build']['device']</code> will output <em>atmega644</em>.</p>
<div class="fragment"><pre class="fragment">
env.XpccLibrary()
</pre></div><p>This tells SCons two things:</p>
<ol type="1">
<li>You want to use the XPCC library in your program (link to <em>libxpcc.a</em>)</li>
<li>How to build the library</li>
</ol>
<p>As said in the beginning: SConstruct are declarative. So it doesn't matter where you put this line. It can be before or after the Program() builder.</p>
<div class="fragment"><pre class="fragment">
env.Defines()
</pre></div><p>Advise SCons to create a file called <code>defines.hpp</code> with the values form the section 'defines' form our configuration file.</p>
<p>SCons will create this file only when you need it or request it explicitly. Unless your code contains a line like <code>#include "defines.hpp"</code> it won't be created.</p>
<div class="fragment"><pre class="fragment">
env.Alias('size', env.Size(program))
env.Alias('symbols', env.Symbols(program))
</pre></div><p>These targets show useful information about your project, for example how much flash space is used in total or which symbol in your program occupies how much space.</p>
<div class="fragment"><pre class="fragment">
hexfile = env.Hex(program)
</pre></div><p>The result of the <em>Program()</em> builder is a file called <code>example.elf</code>, but most programming tools for the AVRs need a Hex-file instead of an Elf-file.</p>
<p>With this builder we tell SCons to build a Hex-file from our Elf-file.</p>
<div class="fragment"><pre class="fragment">
env.Alias('program', env.Avrdude(hexfile))
</pre></div><p>The Hex-file now can be used to program the AVR using avrdude. The neccessary information about how to do are collected from the <em>avrdude</em> section of the configuration file.</p>
<p>Here you see another feature of SCons: aliases. Aliases can be used the create commandline targets. When you type <code>scons program</code> SCons will call the avrdude builder.</p>
<p>Read more about aliases in the official documentation: <a href="http://www.scons.org/doc/HTML/scons-user/c4322.html">Alias Targets</a></p>
<div class="fragment"><pre class="fragment">
env.Alias('fuse', env.AvrdudeFuses())
</pre></div><p>Just as programming the flash you can program the fuses of the AVR. Therefore you need a <em>fusebits</em> section in the configuration file.</p>
<p>To calculate the hex-values it is most convenient to use something like the <a href="http://www.engbedded.com/fusecalc/">Online Fuse Calculator</a>.</p>
<div class="fragment"><pre class="fragment">
env.Alias('build', [hexfile, env.Listing(program)])
env.Alias('all', ['build', 'size'])
</pre></div><p>Some more aliases. As you can see aliases can point to more that one target.</p>
<div class="fragment"><pre class="fragment">
env.Default('all')
</pre></div><p>Set the default target to <em>all</em>. This target will be build when nothing else is specifiy via the commandline. </p>
</div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="index.html">Cross Platform Component Communication</a>      </li>
      <li class="navelem"><a class="el" href="build_system.html">3. Build system</a>      </li>
<hr class="footer" />
<address class="footer"><small>Generated on Tue Jun 5 2012 21:41:32 for xpcc by&nbsp;<a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.png" alt="doxygen" border="0" /></a> 1.7.6.1</small></address>

<!-- Piwik -->
<script type="text/javascript">
var pkBaseURL = (("https:" == document.location.protocol) ? "https://sourceforge.net/apps/piwik/xpcc/" : "http://sourceforge.net/apps/piwik/xpcc/");
document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
</script>

<script type="text/javascript">
try {
	var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
	piwikTracker.trackPageView();
	piwikTracker.enableLinkTracking();
} catch( err ) {}
</script>
<noscript>
<p><img src="http://sourceforge.net/apps/piwik/xpcc/piwik.php?idsite=1" style="border:0" alt=""/></p>
</noscript>
<!-- End Piwik Tag -->

</body>
</html>
